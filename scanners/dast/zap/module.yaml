api_version: 1.0

id: dev/zap
name: zap
namespace: dev/zap

config:
  support_diff_scan: false


steps:
  - scan:
      command:
        docker:
          image: owasp/zap2docker-stable
          user: 1000
          command: |
            -c '
              function run() {
                /zap/zap-api-scan.py -t "$TARGET_URL" -f "$API_FORMAT" -J report.json &>/dev/null
                cat /zap/wrk/report.json
              }
              mkdir /zap/wrk
              run || run
            '
          entrypoint: bash
          environment:
            TARGET_URL: ${TARGET_URL}
            API_FORMAT: ${API_FORMAT:-graphql}

      format: sarif
      post-processor:
        docker:
          image: openpolicyagent/opa
          command: |
            eval data.sarif.output --bundle scanners/dast/zap --stdin-input --format pretty
          workdir: /src
