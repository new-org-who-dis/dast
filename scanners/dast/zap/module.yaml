api_version: 1.0

id: dev/zap
name: zap
namespace: dev/zap

config:
  support_diff_scan: false


steps:
  - run: |
      touch report.json
      chmod a+w report.json

  - scan:
      command:
        docker:
          image: owasp/zap2docker-stable
          workdir: /zap/wrk
          command: |
            -c '
              function run() {
                /zap/zap-api-scan.py -t "$TARGET_URL" -f "$API_FORMAT" -l INFO -s -J report.json &>/dev/null
                cat report.json
              }
              run || run
            '
          entrypoint: bash
          environment:
            TARGET_URL: ${TARGET_URL}
            API_FORMAT: ${API_FORMAT:-graphql}
            ZAP_AUTH_HEADER_SITE: ${ZAP_AUTH_HEADER_SITE:-}
            ZAP_AUTH_HEADER_VALUE: ${ZAP_AUTH_HEADER_VALUE:-}
            ZAP_AUTH_HEADER: ${ZAP_AUTH_HEADER:-}


      format: sarif
      post-processor:
        docker:
          image: python:3.11.0-slim
          entrypoint: python
          command: scanners/dast/zap/sarif.py
          workdir: /src
